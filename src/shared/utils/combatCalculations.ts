import type { Card } from '@/types/card.types';
import type { DiceResults, CombatCalculation } from '@/types/combat.types';

/**
 * Calculate combat results from dice rolls and card modifiers
 */
export const calculateCombatResult = (
  diceResults: DiceResults,
  playerCard: Card,
  enemyCard: Card
): CombatCalculation => {
  const playerAttackTotal = diceResults.playerAttack + playerCard.attackMod;
  const playerDefenseTotal = diceResults.playerDefense + playerCard.defenseMod;
  const enemyAttackTotal = diceResults.enemyAttack + enemyCard.attackMod;
  const enemyDefenseTotal = diceResults.enemyDefense + enemyCard.defenseMod;

  // Damage to enemy
  const playerRawDamage = playerAttackTotal;
  const enemyReduction = Math.min(enemyDefenseTotal * 0.1, 0.6); // Max 60% reduction
  const damageToEnemy = Math.max(1, Math.round(playerRawDamage * (1 - enemyReduction)));

  // Damage to player
  const enemyRawDamage = enemyAttackTotal;
  const playerReduction = Math.min(playerDefenseTotal * 0.1, 0.6); // Max 60% reduction
  const damageToPlayer = Math.max(1, Math.round(enemyRawDamage * (1 - playerReduction)));

  return {
    playerAttack: playerAttackTotal,
    playerDefense: playerDefenseTotal,
    enemyAttack: enemyAttackTotal,
    enemyDefense: enemyDefenseTotal,
    damageToEnemy,
    damageToPlayer,
  };
};

/**
 * Apply damage to cards and return updated versions
 */
export const applyDamage = (
  playerCard: Card,
  enemyCard: Card,
  calculation: CombatCalculation
): { updatedPlayer: Card; updatedEnemy: Card } => {
  const updatedPlayer: Card = {
    ...playerCard,
    currentHp: Math.max(0, playerCard.currentHp - calculation.damageToPlayer),
  };

  const updatedEnemy: Card = {
    ...enemyCard,
    currentHp: Math.max(0, enemyCard.currentHp - calculation.damageToEnemy),
  };

  return { updatedPlayer, updatedEnemy };
};

/**
 * Check if combat is finished
 */
export const isCombatFinished = (playerCard: Card, enemyCard: Card): boolean => {
  return playerCard.currentHp <= 0 || enemyCard.currentHp <= 0;
};

/**
 * Determine winner of combat
 */
export const getWinner = (playerCard: Card, enemyCard: Card): 'player' | 'enemy' | null => {
  if (enemyCard.currentHp <= 0) return 'player';
  if (playerCard.currentHp <= 0) return 'enemy';
  return null;
};
